# Extravio Tools - AI Context

## Project Overview

**extravio_tools** is a collection of bash/zsh compatible networking and automation utilities for managing SSH connections, file transfers, and remote command execution across multiple hosts. The project emphasizes usability through partial matching, shell completion, and automatic network management.

## Architecture

### Core Components

1. **JSON Configuration System** (`routing/routes.json`)
   - Centralized route definitions with structured fields
   - Format: `{"alias": {"username": "user", "hostroute": "host", "tailscale_required": true/false, "hosttype": "standard"/"ha"}}`
   - Replaces legacy bash case statements with structured data

2. **Route Parser** (`routing/get_routes.sh`)
   - JSON configuration parser providing routing functions
   - Functions: `get_address()`, `find_partial_matches()`, `get_best_match()`
   - Bash 3.2+ compatible for macOS compatibility
   - Supports partial string matching with disambiguation

3. **Shell Completion System** (`routing/completion.sh`)
   - Cross-shell compatibility (bash/zsh)
   - Auto-detects shell type via `$BASH_VERSION` vs `$ZSH_VERSION`
   - Provides tab completion for route aliases
   - Sources route data from get_routes.sh

4. **Common Utilities** (`routing/common.sh`)
   - Shared functions for SSH agent management
   - Tailscale connectivity management with conditional disable
   - Environment variable: `EXTRAVIO_DISABLE_TAILSCALE_WHEN_NOT_NEEDED=true`

### Tool Suite

#### Primary Tools

- **`routeto`**: SSH connection tool with partial matching and docker container support
- **`file_copy`**: SCP wrapper with route alias support
- **`remote-ha`**: Home Assistant CLI remote execution
- **`remote-docker`**: Docker container command execution on remote hosts

#### Utility Tools

- **`create_ssh_key.sh`**: Interactive SSH key generation
- **`git_init_repo`**: Git repository initialization
- **`list_dns`**: DNS lookup utility
- **`install.sh`**: Automated PATH and completion setup

## Key Features

### Partial Matching System
```bash
# Example: "ha-p" matches "ha-primary"
routeto ha-p  # Connects to ha-primary if unambiguous
```
- Implemented in `find_partial_matches()` and `get_best_match()`
- Handles ambiguous matches with user-friendly error messages
- Case-sensitive matching for precision

### Shell Completion
- Works in both bash and zsh environments
- Provides route alias completion for all routing tools
- Installed automatically via `install.sh`
- Sources: `source "$PROJECT_ROOT/routing/completion.sh"`

### Network Management
- Automatic Tailscale activation for routes marked `tailscale_required: true`
- Conditional deactivation via environment variable
- SSH agent lifecycle management
- Connection timeout handling

## Technical Specifications

### Compatibility
- **Shell**: bash 3.2+ or zsh (macOS compatible)
- **Dependencies**: jq, ssh, scp, tailscale (optional)
- **Platform**: macOS primary, Linux compatible

### Configuration Management
Routes are defined in `routing/routes.json`:
```json
{
  "alias": {
    "username": "user",
    "hostroute": "hostname.example.com",
    "tailscale_required": true,
    "hosttype": "standard"
  },
  "ha-primary": {
    "username": "core",
    "hostroute": "homeassistant.local",
    "tailscale_required": false,
    "hosttype": "ha"
  },
  "dev-container": {
    "username": "user",
    "hostroute": "docker-host.example.com",
    "dockercontainer": "my-dev-container", 
    "tailscale_required": false,
    "hosttype": "docker"
  }
}
```

### Error Handling
- JSON syntax validation (no comments allowed)
- SSH connection timeout detection
- Partial match ambiguity resolution
- Shell compatibility checks

## File Structure
```
extravio_tools/
├── create_ssh_key.sh       # SSH key generation utility
├── git_init_repo           # Git repository initialization
├── install.sh              # Automated installation script
├── list_dns                # DNS lookup utility
├── README.md               # User documentation
└── routing/
    ├── common.sh            # Shared utility functions
    ├── completion.sh        # Cross-shell completion system
    ├── file_copy           # File transfer tool with route aliases
    ├── get_routes.sh       # JSON configuration parser
    ├── routes.conf         # Legacy config (deprecated)
    ├── routes.json         # Primary route configuration
    └── routeto            # SSH connection tool
```

## Development Notes

### Shell Compatibility
- Use `[[ ]]` for conditionals instead of `[ ]`
- Avoid bash 4+ features for macOS compatibility
- Test completion in both bash and zsh

### JSON Parsing
- Use `jq` for all JSON operations
- Avoid JSON comments (breaks jq parsing)
- Handle empty/missing fields gracefully

### Function Dependencies
- All routing tools source `get_routes.sh` and `common.sh`
- Completion system depends on `get_routes.sh`
- Install script manages PATH and completion setup

### Environment Variables
- `EXTRAVIO_DISABLE_TAILSCALE_WHEN_NOT_NEEDED=true`: Disables Tailscale for routes not requiring it
- Detection via `$BASH_VERSION` and `$ZSH_VERSION` for shell-specific behavior

## Usage Patterns

### Adding New Routes
1. Edit `routing/routes.json`
2. Add route object with required fields
3. Test with `routeto <new-alias>`
4. Completion updates automatically

### Troubleshooting
- Check JSON syntax with `jq . routing/routes.json`
- Verify shell compatibility with version checks
- Test partial matching with `find_partial_matches()`
- Reload completion with `source routing/completion.sh`

### Extension Points
- Add new tools by sourcing `get_routes.sh` and `common.sh`
- Extend JSON schema with additional fields
- Add new completion contexts in `completion.sh`

## Integration Notes

This project integrates with:
- **Tailscale**: Network connectivity management
- **Home Assistant**: Remote CLI execution
- **SSH ecosystem**: Key management and agent handling
- **Shell environments**: bash/zsh completion and PATH management

The codebase prioritizes usability, maintainability, and cross-platform compatibility while providing a cohesive toolkit for remote system management.