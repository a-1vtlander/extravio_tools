#!/bin/bash

# file_copy script: copies a file to a route destination using scp

source "$(dirname "$0")/get_routes.sh"
source "$(dirname "$0")/common.sh"

ensure_ssh_agent

handle_scp_error() {
    output="$1"
    alias="$2"
    if echo "$output" | grep -q "permission denied"; then
        echo "Permission denied for $alias. Check remote user permissions or try a different destination path."
    else
        echo "SCP failed for $alias: $output"
    fi
}

copy_via_ssh() {
    local src="$1"
    local host="$2"
    local dst="$3"
    if [ -d "$src" ]; then
        echo "Directory copy via SSH not supported for $alias. Use SCP or manual method."
        return 1
    fi
    local target="$dst"
    if [[ "$dst" == */ ]]; then
        target="$dst$(basename "$src")"
    fi
    # Try to create the target directory with sudo
    ssh "$host" "sudo mkdir -p \"$(dirname "$target")\"" 2>/dev/null || true
    cat "$src" | ssh "$host" "sudo tee '$target' > /dev/null"
}

if [ $# -lt 3 ] || [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    echo "Usage: $(basename "$0") <route> <source> <destination>"
    echo "Available routes:"
    for key in "${keys[@]}"; do
        echo "  $key"
    done
    echo ""
    echo "This script copies files to various devices via SCP."
    echo "For Tailscale-enabled routes (pi-tailscale), it ensures Tailscale is active."
    echo "Local routes connect directly."
    echo ""
    echo "Routes:"
    for key in "${keys[@]}"; do
        addr=$(get_address "$key")
        host=$(echo "$addr" | cut -d: -f1)
        needs_ts=$(echo "$addr" | cut -d: -f2)
        echo "  $key -> $host (Tailscale: $needs_ts)"
    done
    exit 0
fi

alias="$1"
src="$2"
dst="$3"

if [ ! -e "$src" ]; then
    echo "Error: Source file/directory '$src' not found."
    exit 1
fi

# Try to get best match (exact or partial)
best_match=$(get_best_match "$alias")
match_result=$?

if [ $match_result -eq 0 ]; then
    addr=$(get_address "$best_match")
    host=$(echo "$addr" | cut -d: -f1)
    needs_ts=$(echo "$addr" | cut -d: -f2)
    if [ "$best_match" != "$alias" ]; then
        echo "-> Using partial match: '$alias' -> '$best_match'"
    fi
    ensure_tailscale "$needs_ts"
    echo "Copying $src to $host:$dst..."
    if [[ "$best_match" == ha-* ]]; then
        echo "Using SSH for copy (SCP not supported for $best_match)..."
        output=$(copy_via_ssh "$src" "$host" "$dst" 2>&1)
        exit_code=$?
    else
        if [ -d "$src" ]; then
            echo "Running: scp -r -o ConnectTimeout=10 \"$src\" \"$host:$dst\""
            output=$(scp -r -o ConnectTimeout=10 "$src" "$host:$dst" 2>&1)
        else
            echo "Running: scp -o ConnectTimeout=10 \"$src\" \"$host:$dst\""
            output=$(scp -o ConnectTimeout=10 "$src" "$host:$dst" 2>&1)
        fi
        exit_code=$?
    fi
    if [ $exit_code -eq 0 ]; then
        echo "File copied successfully."
    else
        handle_scp_error "$output" "$best_match"
        exit 1
    fi
elif [ $match_result -eq 2 ]; then
    echo "Ambiguous alias: $alias"
    echo "Multiple matches found:"
    find_partial_matches "$alias" | sed 's/^/  /'
    exit 1
else
    echo "Unknown alias: $alias"
    echo "Available aliases:"
    for key in "${keys[@]}"; do
        echo "  $key"
    done
    exit 1
fi