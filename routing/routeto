#!/bin/bash

# routeto script: takes an alias (script name) as argument and executes the corresponding SSH command

source "$(dirname "$0")/routes.conf"

# Check and start ssh-agent if not running
if ! ssh-add -l >/dev/null 2>&1; then
    echo "Starting ssh-agent..."
    eval "$(ssh-agent -s)"
    # Add all private keys corresponding to .pub files in ~/.ssh
    for pub in ~/.ssh/*.pub; do
        priv="${pub%.pub}"
        if [ -f "$priv" ]; then
            ssh-add "$priv"
        fi
    done
fi

handle_ssh_error() {
    output="$1"
    alias="$2"
    if echo "$output" | grep -q "Connection refused\|No route to host\|Network is unreachable\|Connection timed out\|Operation timed out"; then
        echo "Error: Server unreachable ($alias)"
    elif echo "$output" | grep -q "Permission denied\|Host key verification failed"; then
        echo "Error: Authentication failed ($alias)"
    else
        echo "Error: SSH failed ($alias) - $output"
    fi
}

run_ssh() {
    # Test connection with 5-second timeout to quickly check reachability without hanging
    output=$(ssh -o BatchMode=yes -o ConnectTimeout=5 "$@" echo "connected" 2>&1)
    exit_code=$?
    if [ $exit_code -eq 0 ]; then
        # Connection successful, run interactive SSH
        ssh "$@"
    else
        handle_ssh_error "$output" "$alias"
    fi
}

if [ $# -eq 0 ] || [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    echo "Usage: $(basename "$0")"
    echo ""
    echo "This script routes SSH connections to various devices."
    echo "For Tailscale-enabled routes (pi-tailscale), it ensures Tailscale is active."
    echo "Local routes connect directly."
    echo ""
    echo "Routes:"
    for key in "${keys[@]}"; do
        addr=$(get_address "$key")
        host=$(echo "$addr" | cut -d: -f1)
        needs_ts=$(echo "$addr" | cut -d: -f2)
        echo "  $key -> $host (Tailscale: $needs_ts)"
    done
    exit 0
fi

alias="$1"

if get_address "$alias" >/dev/null 2>&1; then
    addr=$(get_address "$alias")
    host=$(echo "$addr" | cut -d: -f1)
    needs_ts=$(echo "$addr" | cut -d: -f2)
    if [ "$needs_ts" = "yes" ]; then
        echo "Ensuring Tailscale is active..."
        tailscale up
    fi
    run_ssh "$host"
else
    echo "Unknown alias: $alias"
    echo "Available aliases: ha-backup, park-st-mac, ha-primary, pi-tailscale, pi-vtlander"
    exit 1
fi