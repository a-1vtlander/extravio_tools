# Extravio Tools - AI Context

## Project Overview
A collection of shell-based networking and automation tools designed to simplify SSH connectivity, file transfers, and remote command execution across multiple hosts, with special support for Tailscale-routed networks and Home Assistant instances.

## Architecture

### Core Components

#### 1. Routing System (`routing/`)
The routing system provides a centralized configuration-based approach to managing SSH connections.

**Key Files:**
- `routes.json` - Central route definition file with structured JSON format
- `get_routes.sh` - JSON parser providing both legacy and new field-based access functions
- `common.sh` - Shared utility functions for SSH agent and Tailscale management
- `routeto` - Interactive SSH connection tool using route aliases
- `file_copy` - SCP/SSH file transfer tool using route aliases

**JSON Structure:**
```json
{
  "alias": {
    "username": "ssh_username",
    "hostroute": "hostname_or_ip", 
    "tailscale_required": "yes|no",
    "hosttype": "ha|pi|mac|pc|unknown"
  }
}
```

**Route Format:**
```bash
alias -> user@host:needs_tailscale
```

**Design Patterns:**
- Route aliases abstract connection details
- Automatic Tailscale connectivity management
- SSH agent lifecycle management
- Timeout-based connection testing
- Special handling for Home Assistant instances (SCP not supported)

#### 2. Home Assistant Integration (`remote-ha`)
Executes Home Assistant CLI commands on remote instances with enhanced output formatting.

**Features:**
- Shortened alias support (e.g., `primary` â†’ `ha-primary`)
- Automatic HA environment sourcing (`/etc/profile.d/homeassistant.sh`)
- Box-formatted output for readability
- Proper argument escaping for remote execution
- Exit code propagation

#### 3. Utility Scripts
- `create_ssh_key.sh` - Interactive SSH key generation (ed25519, RSA, ECDSA)
- `git_init_repo` - GitHub repository initialization with authentication
- `install.sh` - PATH configuration for project directories
- `list_dns` - DNS-SD service discovery for SSH services

## Technical Considerations

### Compatibility
- **Bash Version:** Designed for Bash 3.2+ (macOS default)
- **Route Lookup:** JSON-based configuration parsed with `jq`
- **SSH Options:** Uses `-o ConnectTimeout` for timeout control

### Security
- SSH agent integration for key management
- Automatic key loading from `~/.ssh/`
- No hardcoded passwords
- GitHub token prompt (no echo for secure input)

### Network Requirements
- Tailscale for remote access to marked routes
- Local network for non-Tailscale routes
- DNS-SD/Bonjour for `.local` hostname resolution

### Error Handling
- Connection timeout detection
- Authentication failure handling
- Network unreachability detection
- Graceful fallbacks (e.g., SSH copy when SCP fails)

## Use Cases

### 1. Quick SSH Access
```bash
routeto ha-primary           # SSH to primary Home Assistant
routeto pi-tailscale         # SSH to Raspberry Pi via Tailscale
```

### 2. Remote Command Execution
```bash
remote-ha primary core info --raw
remote-ha backup supervisor info
```

### 3. File Transfer
```bash
file_copy ha-primary config.yaml /config/
file_copy pi-vtlander script.sh /home/a-1vtlander/
```

### 4. SSH Key Setup
```bash
./create_ssh_key.sh        # Interactive key generation
```

## Extension Points

### Adding New Routes
Edit `routing/routes.json`:
```json
{
  "new-alias": {
    "username": "myuser",
    "hostroute": "hostname.example.com", 
    "tailscale_required": "yes",
    "hosttype": "pc"
  }
}
```

The `get_routes.sh` script automatically parses this JSON and provides:
- `get_address()` function (legacy format: "user@host:needs_tailscale")
- `get_route_field()` function for individual field access
- `keys` array with all route aliases

### Custom Remote Commands
The `remote-ha` pattern can be adapted for other remote systems:
1. Source `routes.conf` and `common.sh`
2. Implement connection logic
3. Build properly escaped remote command string
4. Execute via SSH with environment setup

### Environment-Specific Configuration
Currently uses direct IP addresses and hostnames. Could be enhanced with:
- Environment variable overrides
- Alternative config file support
- Dynamic route discovery

## Code Patterns

### Safe Argument Passing
```bash
remote_cmd="ha"
for arg in "$@"; do
  remote_cmd+=" $(printf '%q' "$arg")"
done
```

### Conditional Tailscale Activation
```bash
ensure_tailscale() {
    local needs_ts="$1"
    local disable_when_not_needed="${EXTRAVIO_DISABLE_TAILSCALE_WHEN_NOT_NEEDED:-no}"
    
    if [ "$needs_ts" = "yes" ]; then
        # Activate Tailscale if not running
        tailscale up
    else
        # Optionally disable when not needed
        if [ "$disable_when_not_needed" = "yes" ]; then
            tailscale down
        fi
    fi
}
```

### Connection Testing with Timeout
```bash
output=$(ssh -o BatchMode=yes -o ConnectTimeout=5 "$host" echo "connected" 2>&1)
if [ $exit_code -eq 0 ]; then
    ssh "$@"  # Proceed with interactive SSH
fi
```

### Dynamic Box Formatting
Output is wrapped in ASCII boxes with dynamic width calculation, falling back to plain output if width exceeds 200 characters.

## Dependencies
- `bash` (3.2+)
- `jq` - JSON processor for parsing route configuration
- `ssh` / `scp`
- `tailscale` (optional, for Tailscale routes)
- `git` (for `git_init_repo`)
- `ssh-keygen` (for `create_ssh_key.sh`)
- `dns-sd` (for `list_dns`)
- `curl` (for `git_init_repo`)

## Known Limitations
- SCP not supported on Home Assistant routes (uses SSH + tee workaround)
- GitHub personal access token required for `git_init_repo`
- Hardcoded GitHub username in `git_init_repo`
- No support for SSH config file integration
- Route definitions require manual editing
